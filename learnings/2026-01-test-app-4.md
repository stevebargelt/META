# test-app-4 Retrospective

**Date:** 2026-01-28
**Project:** Bookmark Manager (Express + SQLite backend, React + Vite frontend)
**Pipeline:** `project` → `bookmark-manager` (8 steps)
**Result:** Success — all steps completed, 101 tests passing, quality gate passed

---

## Summary

test-app-4 validated the META framework after significant changes: collapsed pipelines, quality-gate.sh, auto-commit, standardized prompts, and restructured base.md. The run exposed 4 bugs in parallel group handling (all fixed) and produced a working, tested application.

---

## Metrics

| Metric | Value |
|--------|-------|
| Steps completed | 8/8 |
| Tests | 101 (47 server, 54 client) |
| Quality gate | 5/5 checks pass |
| Git commits | 12 (auto-commit worked) |
| Files created | ~80 (server + client) |

---

## What Went Well

### 1. Contract-first parallel build
- Step 2 (architect) created `docs/openapi.yaml`
- Steps 3 (backend) and 4 (frontend) built independently against the spec
- Reviewer confirmed both sides conform — no integration issues

### 2. Quality gate drove a real fix
- Definition of Done (step 7) noted "observability not implemented"
- Quality gate (step 8) failed on correlationId check
- Agent added correlation ID middleware to fix it
- This is the intended behavior: machine-verifiable checks catching gaps

### 3. Feature-first structure adopted
Both server/ and client/ use feature directories:
```
server/src/features/
  bookmarks/   # CRUD, routes, validation
  tags/        # Tag management
  import-export/  # HTML parser, exports

client/src/features/
  bookmarks/   # List, card, form
  tags/        # Sidebar
  search/      # Search bar
  import-export/  # Import/export panel
```

### 4. Auto-commit created useful history
Each step produced a commit:
```
dc21eb8 meta: step 8 (base) complete
200b5b6 meta: step 7 (base) complete
b2d5743 meta: step 6 (base) complete
a954af4 meta: step 5 (reviewer) complete
49a4364 meta: step 2 (architect) complete
5a04f08 meta: step 1 (base) complete
```

### 5. Production-quality output
- README: 125 lines, all sections filled
- CI pipeline: GitHub Actions configured
- Tests: Full coverage of features
- Docs: OpenAPI spec, architecture doc

---

## Bugs Fixed in META

| Bug | Location | Fix |
|-----|----------|-----|
| `failed_steps[@]` unbound | scripts/meta:726 | Added array length guard |
| `launched_steps[@]` unbound | scripts/meta:709 | Added array length guard |
| `completed_steps[@]` unbound (2 places) | scripts/meta:779,802 | Added array length guards |
| `group_label` undefined | scripts/meta:796 | Changed to `group` |

**Root cause:** Bash `set -u` fails when iterating empty arrays with `"${arr[@]}"`. The parallel group code path hadn't been exercised with successful runs where `failed_steps` was empty.

**Commits:**
- `b316a9b` — Fix unbound variable error in parallel group handling
- `d1bea6e` — Fix group_label typo and guard remaining array iterations

---

## Issues Encountered

### 1. Step 3 handoff not merged
Crash occurred after step 3 completed but before `handoff_merge_step()` ran. The `.handoff-step-3.md` file exists with full content but wasn't appended to main handoff.

**Impact:** Low — content preserved, just not consolidated.

### 2. Single-step "parallel groups"
The orchestrator created separate groups for backend (step 3) and frontend (step 4):
```
3 | base | auto | backend | ...
4 | base | auto | frontend | ...
```

These run sequentially because they're different groups. True parallelism requires same group value:
```
3 | base | auto | build | ...
4 | base | auto | build | ...
```

**Learning:** Update orchestrator.md to clarify parallel group semantics.

### 3. Resume doesn't preserve CLI flags
`--auto-approve` had to be re-added on each resume. State file tracks run progress but not invocation flags.

---

## Recommended META Changes

### Already Done
- Array iteration guards (4 places)
- `group_label` → `group` typo fix

### Should Consider

**1. Persist CLI flags in state file**
Save `--auto-approve`, `--unsafe`, `--cli` so resume preserves them:
```bash
state_set "$state_file" "auto_approve" "$auto_approve"
```

**2. Clean up step handoff files after merge**
Currently `.handoff-step-N.md` files remain after merge. Options:
- Delete after merge
- Move to `.meta/steps/$run_id/`
- Leave as-is (harmless)

**3. Clarify parallel group semantics in orchestrator.md**
Add explicit guidance:
- Same `PARALLEL_GROUP` value = concurrent execution
- Different values = sequential groups
- Empty = sequential step

**4. Add merge recovery on resume**
If crash happens between step completion and merge, retry merge on resume.

---

## Framework Validation

test-app-4 demonstrated the intended flow:

1. **Kickoff** → Gathered requirements interactively
2. **PRD** → Product manager wrote `docs/PRD.md`
3. **Architecture** → Architect designed structure, chose stack
4. **Contract** → Created OpenAPI spec before parallel work
5. **Parallel build** → Backend and frontend built independently
6. **Review** → Reviewer checked contract conformance
7. **DoD** → Checklist verification
8. **Quality gate** → Machine-verifiable checks, fixed gaps

The framework works. Bugs were edge cases that only surface with successful parallel runs.

---

## Key Learnings

1. **Contract stub timing is critical** — OpenAPI before parallel work enables independent builds without integration surprises.

2. **Quality gate as fixer** — Step 8 didn't just verify; it fixed the observability gap. Document this as expected behavior.

3. **Parallel group syntax** — `PARALLEL_GROUP` column groups steps. Same value = concurrent. Different values = sequential.

4. **Empty array iteration** — Always guard with `[[ ${#arr[@]} -gt 0 ]]` before `for x in "${arr[@]}"` when using `set -u`.

5. **Auto-commit value** — Having commits per step made debugging and understanding progress much easier.
